<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>事件详情 - 慈善事件管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-heart"></i>
                <span>慈善事件管理</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i> 首页
                </a>
                <a href="search.html" class="nav-link">
                    <i class="fas fa-search"></i> 搜索事件
                </a>
                <a href="#" class="nav-link" onclick="showAbout()">
                    <i class="fas fa-info-circle"></i> 关于我们
                </a>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main>
        <!-- 事件详情头部 -->
        <section class="event-header">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html"><i class="fas fa-home"></i> 首页</a>
                    <i class="fas fa-chevron-right"></i>
                    <span id="eventTitle">事件详情</span>
                </div>
            </div>
        </section>

        <!-- 事件详情内容 -->
        <section class="event-detail">
            <div class="container">
                <div class="event-detail-grid">
                    <!-- 事件信息卡片 -->
                    <div class="event-info-card">
                        <div class="event-image-large">
                            <i class="fas fa-calendar-check"></i>
                            <div class="event-status" id="eventStatus">即将开始</div>
                        </div>
                        
                        <div class="event-info-content">
                            <h1 id="eventName">事件名称</h1>
                            <div class="event-meta-detailed">
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span id="eventDate">事件日期</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span id="eventLocation">事件地点</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-tag"></i>
                                    <span id="eventCategory">事件分类</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-users"></i>
                                    <span id="eventCapacity">容量信息</span>
                                </div>
                            </div>
                            
                            <div class="event-description-detailed">
                                <h3>事件描述</h3>
                                <p id="eventDescription">事件详细描述...</p>
                            </div>
                            
                            <div class="event-stats">
                                <div class="stat-box">
                                    <div class="stat-number" id="registrationCount">0</div>
                                    <div class="stat-label">已注册</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-number" id="ticketsSold">0</div>
                                    <div class="stat-label">已售票</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-number" id="currentAmount">$0</div>
                                    <div class="stat-label">已筹款</div>
                                </div>
                            </div>
                            
                            ${getQueryParam('id') ? `
                            <div class="event-actions-detailed">
                                <button class="btn btn-primary btn-large" onclick="registerForEvent()">
                                    <i class="fas fa-user-plus"></i> 立即注册
                                </button>
                                <button class="btn btn-secondary btn-large" onclick="shareEvent()">
                                    <i class="fas fa-share"></i> 分享事件
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- 筹款进度 -->
                    <div class="event-progress-card" id="progressCard" style="display: none;">
                        <h3>筹款进度</h3>
                        <div class="progress-container">
                            <div class="progress-bar-large">
                                <div class="progress-fill-large" id="progressFill"></div>
                            </div>
                            <div class="progress-info">
                                <span id="progressText">0% 完成</span>
                                <span id="progressAmount">$0 / $0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 注册列表 -->
                    <div class="registration-list-card">
                        <h3>参与记录</h3>
                        <div class="registration-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="totalRegistrations">0</span>
                                <span class="stat-label">总参与人数</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="totalTickets">0</span>
                                <span class="stat-label">总售票数</span>
                            </div>
                        </div>
                        
                        <div class="registration-list" id="registrationList">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>加载参与记录...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>关于我们</h3>
                    <p>致力于连接慈善组织与爱心人士，推动社会公益事业的发展。</p>
                </div>
                <div class="footer-section">
                    <h3>联系方式</h3>
                    <p><i class="fas fa-envelope"></i> contact@charityevents.com</p>
                    <p><i class="fas fa-phone"></i> +61 2 1234 5678</p>
                </div>
                <div class="footer-section">
                    <h3>关注我们</h3>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 慈善事件管理系统. PROG2002 A3项目.</p>
            </div>
        </div>
    </footer>

    <!-- 模态框 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // API配置
        const API_BASE_URL = window.location.origin + '/api';
        let currentEvent = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventPage();
        });

        // 初始化事件页面
        async function initializeEventPage() {
            const eventId = getQueryParam('id');
            if (!eventId) {
                showError('未指定事件ID');
                return;
            }

            try {
                await loadEventDetails(eventId);
                await loadEventRegistrations(eventId);
            } catch (error) {
                console.error('初始化失败:', error);
                showError('加载事件详情失败');
            }
        }

        // 获取URL参数
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // 加载事件详情
        async function loadEventDetails(eventId) {
            try {
                const response = await fetch(`${API_BASE_URL}/events/${eventId}`);
                const result = await response.json();

                if (result.success) {
                    currentEvent = result.data;
                    displayEventDetails(currentEvent);
                } else {
                    showError(result.error || '事件不存在');
                }
            } catch (error) {
                console.error('加载事件详情失败:', error);
                showError('加载事件详情失败');
            }
        }

        // 显示事件详情
        function displayEventDetails(event) {
            // 更新页面标题
            document.getElementById('eventTitle').textContent = event.event_name;
            document.getElementById('eventName').textContent = event.event_name;
            document.getElementById('eventDate').textContent = formatDate(event.event_date);
            document.getElementById('eventLocation').textContent = event.event_location;
            document.getElementById('eventCategory').textContent = event.category_name || '未分类';
            document.getElementById('eventDescription').textContent = event.event_description || '暂无描述';
            
            // 更新事件状态
            const statusElement = document.getElementById('eventStatus');
            statusElement.textContent = getStatusText(event.event_status);
            statusElement.className = `event-status status-${event.event_status}`;
            
            // 更新容量信息
            document.getElementById('eventCapacity').textContent = 
                `${event.total_tickets_sold || 0} / ${event.max_tickets} 人已参与`;
            
            // 更新统计数据
            document.getElementById('registrationCount').textContent = event.registration_count || 0;
            document.getElementById('ticketsSold').textContent = event.total_tickets_sold || 0;
            document.getElementById('currentAmount').textContent = 
                `$${(event.current_amount || 0).toLocaleString()}`;

            // 显示筹款进度（如果有目标金额）
            if (event.goal_amount > 0) {
                displayProgress(event.current_amount, event.goal_amount);
            }
        }

        // 显示筹款进度
        function displayProgress(current, goal) {
            const progressCard = document.getElementById('progressCard');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressAmount = document.getElementById('progressAmount');

            const percentage = Math.min((current / goal) * 100, 100);
            
            progressCard.style.display = 'block';
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${percentage.toFixed(1)}% 完成`;
            progressAmount.textContent = `$${current.toLocaleString()} / $${goal.toLocaleString()}`;

            // 添加进度动画
            setTimeout(() => {
                progressFill.style.transition = 'width 1s ease-in-out';
            }, 100);
        }

        // 加载事件注册信息
        async function loadEventRegistrations(eventId) {
            try {
                const response = await fetch(`${API_BASE_URL}/registrations?event_id=${eventId}`);
                const result = await response.json();

                if (result.success) {
                    displayEventRegistrations(result.data);
                }
            } catch (error) {
                console.error('加载注册信息失败:', error);
            }
        }

        // 显示事件注册信息
        function displayEventRegistrations(registrations) {
            const container = document.getElementById('registrationList');
            const totalRegElement = document.getElementById('totalRegistrations');
            const totalTicketsElement = document.getElementById('totalTickets');

            // 更新统计信息
            totalRegElement.textContent = registrations.length;
            const totalTickets = registrations.reduce((sum, reg) => sum + (reg.ticket_count || 0), 0);
            totalTicketsElement.textContent = totalTickets;

            if (registrations.length === 0) {
                container.innerHTML = `
                    <div class="no-registrations" style="text-align: center; padding: 40px; color: #7f8c8d;">
                        <i class="fas fa-user-check" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p>暂无参与记录</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">成为第一个参与者吧！</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = registrations.map(registration => createRegistrationItem(registration)).join('');
        }

        // 创建注册项HTML
        function createRegistrationItem(registration) {
            const initials = registration.user_name.split('').filter(char => /[\u4e00-\u9fa5]/.test(char)).slice(0, 2).join('') || 
                            registration.user_name.substring(0, 2).toUpperCase();
            
            return `
                <div class="registration-item fade-in">
                    <div class="registration-avatar">
                        ${initials}
                    </div>
                    <div class="registration-content">
                        <div class="registration-user">${registration.user_name}</div>
                        <div class="registration-email">${registration.user_email}</div>
                        <div class="registration-time">${formatTimeAgo(registration.registration_date)}</div>
                    </div>
                    <div class="registration-tickets">
                        ${registration.ticket_count} 张票
                    </div>
                </div>
            `;
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleDateString('zh-CN', options);
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'upcoming': '即将开始',
                'past': '已结束',
                'suspended': '已暂停'
            };
            return statusMap[status] || status;
        }

        // 格式化时间差
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return '刚刚';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes}分钟前`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours}小时前`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days}天前`;
            }
        }

        // 注册事件
        function registerForEvent() {
            if (!currentEvent) return;

            // 检查事件状态
            if (currentEvent.event_status === 'past') {
                showModal('事件已结束', '对不起，该事件已经结束，无法接受新的注册。');
                return;
            }

            if (currentEvent.event_status === 'suspended') {
                showModal('事件已暂停', '对不起，该事件暂时暂停注册。');
                return;
            }

            // 检查容量
            if (currentEvent.total_tickets_sold >= currentEvent.max_tickets) {
                showModal('事件已满', '对不起，该事件已经达到最大容量，无法接受新的注册。');
                return;
            }

            // 显示注册表单
            showRegistrationForm();
        }

        // 显示注册表单
        function showRegistrationForm() {
            const modalBody = document.getElementById('modal-body');
            
            modalBody.innerHTML = `
                <div style="padding: 30px;">
                    <h2 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
                        <i class="fas fa-user-plus" style="color: #3498db;"></i> 事件注册
                    </h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">${currentEvent.event_name}</h4>
                        <p style="color: #7f8c8d; margin-bottom: 5px;">
                            <i class="fas fa-calendar"></i> ${formatDate(currentEvent.event_date)}
                        </p>
                        <p style="color: #7f8c8d; margin-bottom: 5px;">
                            <i class="fas fa-map-marker-alt"></i> ${currentEvent.event_location}
                        </p>
                        <p style="color: #27ae60; font-weight: 600;">
                            <i class="fas fa-ticket-alt"></i> 
                            ${currentEvent.ticket_price === 0 ? '免费' : `$${currentEvent.ticket_price}`}
                        </p>
                    </div>
                    
                    <form id="registrationForm" style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <label for="userName" style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">
                                姓名 *
                            </label>
                            <input type="text" id="userName" name="userName" required 
                                   style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div>
                            <label for="userEmail" style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">
                                邮箱 *
                            </label>
                            <input type="email" id="userEmail" name="userEmail" required 
                                   style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div>
                            <label for="userPhone" style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">
                                电话
                            </label>
                            <input type="tel" id="userPhone" name="userPhone" 
                                   style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div>
                            <label for="ticketCount" style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">
                                票数 *
                            </label>
                            <select id="ticketCount" name="ticketCount" required 
                                    style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;">
                                ${generateTicketOptions()}
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" onclick="closeModal()" class="btn btn-secondary" style="flex: 1;">
                                <i class="fas fa-times"></i> 取消
                            </button>
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <i class="fas fa-check"></i> 确认注册
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('modal').style.display = 'block';
            
            // 添加表单提交事件
            document.getElementById('registrationForm').addEventListener('submit', handleRegistrationSubmit);
        }

        // 生成票数选项
        function generateTicketOptions() {
            const maxTickets = Math.min(5, currentEvent.max_tickets - (currentEvent.total_tickets_sold || 0));
            let options = '';
            for (let i = 1; i <= maxTickets; i++) {
                options += `<option value="${i}">${i} 张票</option>`;
            }
            return options;
        }

        // 处理注册提交
        async function handleRegistrationSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const registrationData = {
                event_id: currentEvent.event_id,
                user_name: formData.get('userName'),
                user_email: formData.get('userEmail'),
                user_phone: formData.get('userPhone') || null,
                ticket_count: parseInt(formData.get('ticketCount'))
            };

            // 验证表单
            if (!registrationData.user_name || !registrationData.user_email) {
                showModal('表单错误', '请填写所有必填项');
                return;
            }

            // 验证邮箱格式
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(registrationData.user_email)) {
                showModal('邮箱格式错误', '请输入有效的邮箱地址');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/registrations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registrationData)
                });

                const result = await response.json();

                if (result.success) {
                    showModal('注册成功', `
                        <div style="text-align: center;">
                            <i class="fas fa-check-circle" style="color: #27ae60; font-size: 3rem; margin-bottom: 20px;"></i>
                            <h3 style="color: #27ae60; margin-bottom: 15px;">注册成功！</h3>
                            <p>您已成功注册 "${currentEvent.event_name}" 事件。</p>
                            <p>我们会向您的邮箱 ${registrationData.user_email} 发送确认信息。</p>
                            <button onclick="closeModal(); location.reload();" class="btn btn-primary" style="margin-top: 20px;">
                                <i class="fas fa-check"></i> 确定
                            </button>
                        </div>
                    `);
                } else {
                    showModal('注册失败', result.error || '注册失败，请重试');
                }
            } catch (error) {
                console.error('注册失败:', error);
                showModal('注册失败', '网络错误，请重试');
            }
        }

        // 分享事件
        function shareEvent() {
            if (!currentEvent) return;

            const shareUrl = window.location.href;
            const shareText = `快来参加 "${currentEvent.event_name}" 慈善活动！`;

            if (navigator.share) {
                navigator.share({
                    title: shareText,
                    url: shareUrl
                });
            } else {
                // 复制到剪贴板
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showModal('分享链接', `
                        <div style="text-align: center;">
                            <i class="fas fa-link" style="color: #3498db; font-size: 3rem; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 15px;">链接已复制</h3>
                            <p>事件链接已复制到剪贴板，您可以分享给朋友。</p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; word-break: break-all; font-size: 0.9rem;">
                                ${shareUrl}
                            </div>
                        </div>
                    `);
                });
            }
        }

        // 显示模态框
        function showModal(title, content) {
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div style="padding: 30px;">
                    <h2 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
                        ${title}
                    </h2>
                    <div>${content}</div>
                </div>
            `;
            document.getElementById('modal').style.display = 'block';
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // 显示关于我们
        function showAbout() {
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div style="padding: 30px;">
                    <h2 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
                        <i class="fas fa-heart" style="color: #e74c3c;"></i> 关于我们
                    </h2>
                    <div style="line-height: 1.8; color: #34495e;">
                        <p style="margin-bottom: 20px;">
                            慈善事件管理系统是一个致力于连接慈善组织与爱心人士的平台。
                            我们相信每个人都能为社会贡献一份力量。
                        </p>
                        <p style="text-align: center; font-weight: 600; color: #2c3e50;">
                            "参与慈善，改变世界"
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('modal').style.display = 'block';
        }

        // 模态框事件
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('modal');
            const closeBtn = document.querySelector('.close');
            
            if (e.target === modal || e.target === closeBtn) {
                closeModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('modal');
            if (e.key === 'Escape' && modal.style.display === 'block') {
                closeModal();
            }
        });

        console.log('🚀 PROG2002 A3 事件详情页面已加载');
    </script>
</body>
</html>